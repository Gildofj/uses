---
import { CaretDownIcon } from "@phosphor-icons/react/dist/ssr";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { getUrlLocale, useTranslate } from "../i18n/utils";
import type { Category } from "../@types/Category";
import { removerAccents } from "../utils/removeAccents";
import { classNames } from "../utils/classNames";

const DEPRECATED_TAG = "Deprecated";
export interface Props {
  category?: Category;
}

const { category } = Astro.props;
const currentLocale = getUrlLocale(Astro.url);
const t = useTranslate(currentLocale);

const posts = (await getCollection("posts"))
  .filter(p => {
    const [locale] = p.slug.split("/");

    return (
      locale === currentLocale &&
      (category
        ? p.data.tags
            ?.map((t: string) => removerAccents(t).toLowerCase())
            .includes(category.id.toLowerCase())
        : true)
    );
  })
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const activeEquipment = posts.filter(
  post => !post.data.tags?.includes(DEPRECATED_TAG),
);
const outOfuseEquipment = posts.filter(post =>
  post.data.tags?.includes(DEPRECATED_TAG),
);
---

<ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
  {
    activeEquipment.map(post => {
      const [locale, ...slug] = post.slug.split("/");

      return (
        <li class="text-center mb-4">
          <a href={`/uses/${locale}/posts/${slug.join("/")}`}>
            <Image
              class={classNames(
                "border border-purple-300 dark:border-zinc-700 rounded-xl",
              )}
              src={post.data.heroImage || "/uses/cover.jpeg"}
              width={720 * 2}
              height={500 * 2}
              alt="Thumbnail"
              transition:name={post.data.heroImage}
            />
            <div class="mt-3 text-xl">{post.data.title}</div>
            <div class="opacity-70">{post.data.description}</div>
          </a>
        </li>
      );
    })
  }
</ul>

<div
  id="out-of-use-equipments"
  class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out"
>
  <hr
    id="divider"
    class="my-8 border-t border-purple-300 dark:border-zinc-700"
  />
  <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {
      outOfuseEquipment.map(post => {
        const [locale, ...slug] = post.slug.split("/");

        return (
          <li class="text-center mb-4">
            <a href={`/uses/${locale}/posts/${slug.join("/")}`}>
              <Image
                class="border border-purple-300 dark:border-zinc-700 rounded-xl grayscale"
                src={post.data.heroImage || "/uses/cover.jpeg"}
                width={720 * 2}
                height={500 * 2}
                alt="Thumbnail"
              />
              <div class="mt-3 text-xl">{post.data.title}</div>
              <div class="opacity-70">{post.data.description}</div>
            </a>
          </li>
        );
      })
    }
  </ul>
</div>

{
  outOfuseEquipment.length > 0 && (
    <button
      id="load-more-btn"
      data-text-show-more={t("postList.showMore")}
      data-text-show-less={t("postList.showLess")}
      class="cursor-pointer mx-auto mt-6 flex items-center px-4 py-2 rounded-lg bg-purple-200 hover:bg-purple-300 dark:bg-zinc-700 dark:hover:bg-zinc-600 transition-all duration-300"
    >
      <span id="load-more-btn-text">{t("postList.showMore")}</span>
      <CaretDownIcon
        id="load-more-btn-icon"
        className="inline-block w-5 h-5 ml-2 transition-all duration-500 ease-in"
      />
    </button>
  )
}

<script is:inline>
  function initOutOfUseEquipmentsButton() {
    const loadMoreBtn = document.getElementById("load-more-btn");
    const loadMoreBtnText = document.getElementById("load-more-btn-text");
    const loadMoreBtnIcon = document.getElementById("load-more-btn-icon");
    const outOfUseEquipments = document.getElementById("out-of-use-equipments");

    if (loadMoreBtn) {
      loadMoreBtn.addEventListener("click", () => {
        const showMoreText = loadMoreBtn.getAttribute("data-text-show-more");
        const showLessText = loadMoreBtn.getAttribute("data-text-show-less");

        if (
          outOfUseEquipments.style.maxHeight &&
          outOfUseEquipments.style.maxHeight !== "0px"
        ) {
          outOfUseEquipments.style.maxHeight = "0px";
          loadMoreBtnText.textContent = showMoreText;
        } else {
          outOfUseEquipments.style.maxHeight =
            outOfUseEquipments.scrollHeight + "px";

          setTimeout(() => {
            outOfUseEquipments.scrollIntoView({
              behavior: "smooth",
              block: "end",
            });
          }, 300);

          loadMoreBtnText.textContent = showLessText;
        }

        loadMoreBtnIcon.classList.toggle("rotate-180");
      });
    }
  }

  document.addEventListener("astro:page-load", initOutOfUseEquipmentsButton);
</script>
