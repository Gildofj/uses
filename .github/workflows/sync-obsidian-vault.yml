name: Sync Obsidian Vault

on:
  repository_dispatch:
    types: [obsidian-vault-uses-updated]
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  sync-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout blog repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.CAN_DISPATCH_WORKFLOW_TOKEN }}
          fetch-depth: 0 # NecessÃ¡rio para comparaÃ§Ãµes de histÃ³rico

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Checkout Obsidian Vault
        uses: actions/checkout@v6
        with:
          repository: ${{ secrets.OBSIDIAN_VAULT_REPO }}
          token: ${{ secrets.OBSIDIAN_VAULT_TOKEN }}
          path: obsidian-vault-sync
          sparse-checkout: |
            Uses/Posts
            Uses/Images
          sparse-checkout-cone-mode: false

      - name: Sync Obsidian Vault
        run: |
          # Criar diretÃ³rios necessÃ¡rios
          mkdir -p src/content/posts/{en,pt,es} public/assets

          # Copiar posts
          rsync -av --ignore-missing-args obsidian-vault-sync/Uses/Posts/en/ src/content/posts/en/ || true
          rsync -av --ignore-missing-args obsidian-vault-sync/Uses/Posts/pt/ src/content/posts/pt/ || true
          rsync -av --ignore-missing-args obsidian-vault-sync/Uses/Posts/es/ src/content/posts/es/ || true

          # Copiar assets
          rsync -av --ignore-missing-args obsidian-vault-sync/Uses/Images/ public/assets/ || true

          # Processar arquivos importados
          pnpm run import-process

          # Limpar diretÃ³rio temporÃ¡rio
          rm -rf obsidian-vault-sync

      - name: Check for changes
        id: verify-changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ Nenhuma alteraÃ§Ã£o detectada"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ AlteraÃ§Ãµes detectadas:"
            git diff --cached --stat
          fi

      - name: Commit and push changes
        if: steps.verify-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Obsidian Sync Bot"
          git config user.email "bot@obsidian-sync.local"

          # Commit com mensagem detalhada
          git commit -m "chore: sync Obsidian vault changes" \
                     -m "Synced at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
                     -m "Trigger: ${{ github.event_name }}"

          git push origin master

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”„ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.verify-changes.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… Vault sincronizado com sucesso" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ Deploy serÃ¡ acionado automaticamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o para sincronizar" >> $GITHUB_STEP_SUMMARY
          fi
